<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Student Profile | Jahizyah</title>
  <link rel="shortcut icon" href="img/icon.png">
 <link rel="stylesheet" href="css/style22.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
   
  <script src="https://cdn.tailwindcss.com"></script>
  
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: {
              50: '#f0f9ff',
              100: '#e0f2fe',
              200: '#bae6fd',
              300: '#7dd3fc',
              400: '#38bdf8',
              500: '#0ea5e9',
              600: '#0284c7',
              700: '#0369a1',
              800: '#075985',
              900: '#0c4a6e',
            },
            secondary: {
              50: '#f8fafc',
              100: '#f1f5f9',
              200: '#e2e8f0',
              300: '#cbd5e1',
              400: '#94a3b8',
              500: '#64748b',
              600: '#475569',
              700: '#334155',
              800: '#1e293b',
              900: '#0f172a',
            },
            success: {
              50: '#f0fdf4',
              100: '#dcfce7',
              200: '#bbf7d0',
              300: '#86efac',
              400: '#4ade80',
              500: '#22c55e',
              600: '#16a34a',
              700: '#15803d',
              800: '#166534',
              900: '#14532d',
            },
            warning: {
              50: '#fff7ed',
              100: '#ffedd5',
              200: '#fed7aa',
              300: '#fdba74',
              400: '#fb923c',
              500: '#f97316',
              600: '#ea580c',
              700: '#c2410c',
              800: '#9a3412',
              900: '#7c2d12',
            },
          },
          fontFamily: {
            sans: ['Inter', 'ui-sans-serif', 'system-ui', 'sans-serif'],
          },
        }
      }
    }
  </script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
    
    body {
      font-family: 'Inter', sans-serif;
      background-color: #f8fafc;
    }
    
    .gradient-bg {
      background: linear-gradient(135deg, #0ea5e9 0%, #0284c7 100%);
    }
    
    
    
    .progress-bar {
      transition: width 1s ease-in-out;
    }
    
    .nav-link {
      position: relative;
    }
    
    .nav-link::after {
      content: '';
      position: absolute;
      bottom: -2px;
      left: 0;
      width: 0;
      height: 2px;
      background-color: white;
      transition: width 0.3s ease;
    }
    
    .nav-link:hover::after {
      width: 100%;
    }
    
    .card-hover:hover {
      transform: translateY(-5px);
      box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
    }
    
    .avatar-ring {
      box-shadow: 0 0 0 3px #0ea5e9, 0 0 0 6px rgba(14, 165, 233, 0.2);
    }
    
    
    
    .animate-bounce-slow {
      animation: bounce-slow 2s infinite;
    }
    
    @keyframes bounce-slow {
      0%, 100% {
        transform: translateY(0);
      }
      50% {
        transform: translateY(-10px);
      }
    }
    
    .animate-pulse-slow {
      animation: pulse-slow 3s infinite;
    }
    
    @keyframes pulse-slow {
      0%, 100% {
        opacity: 1;
      }
      50% {
        opacity: 0.7;
      }
    }

    /* Custom scrollbar */
    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }

    ::-webkit-scrollbar-track {
      background: #f1f1f1;
      border-radius: 10px;
    }

    ::-webkit-scrollbar-thumb {
      background: #c1c1c1;
      border-radius: 10px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: #a8a8a8;
    }

    /* Custom animations */
    @keyframes float {
      0%, 100% {
        transform: translateY(0);
      }
      50% {
        transform: translateY(-10px);
      }
    }

    

    .streak-fire {
      animation: pulse-slow 1s infinite;
      color: #f97316;
    }

    @keyframes streak-pulse {
      0%, 100% {
        transform: scale(1);
        opacity: 1;
      }
      50% {
        transform: scale(1.1);
        opacity: 0.8;
      }
    }

   
  </style>
 
</head>
<body>
<nav>
    <div class="container nav-container">
      <div class="logo">
        <div class="logo-icon">
          <img src="../../images/Jahizyah.png" alt="Jahizyah Logo" class="logo-image">
        </div>
        <span>Jahizyah</span>
      </div>
      <ul class="nav-links">
        <li><a href="Main-stu.html"><i class="fas fa-home"></i> Home </a></li>
        <li><a href="about-s.html"><i class="fas fa-info-circle"></i> About Us</a></li>
        <li><a href="progress.html"><i class="fas fa-chart-line"></i> Progress</a></li>
        <li><a href="contact-s.html"><i class="fas fa-envelope"></i> Contact Us</a></li>
        <li><a href="setting-stu.html"><i class="fas fa-cog"></i>setting </a></li>
      </ul>
</div>
</nav>

    

  <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <!-- Dashboard Header -->
    <div class="bg-white rounded-xl shadow-md p-6 mb-8 flex flex-col md:flex-row justify-between items-center card-hover transition duration-300">
      <div>
        <h2 class="text-2xl font-bold text-primary-800">Student Profile</h2>
        <p class="text-secondary-500">View and manage your academic progress</p>
      </div>
      <div class="mt-4 md:mt-0 flex items-center space-x-3">
        <span class="text-secondary-700 font-medium" id="username-header"></span>
        <div class="w-10 h-10 rounded-full bg-primary-100 flex items-center justify-center text-primary-600 avatar-ring">
          <i class="fas fa-user-graduate text-xl"></i>
        </div>
      </div>
    </div>

    <!-- Main Content Grid -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
      <!-- Student Profile Card -->
<div class="bg-white rounded-xl shadow-md overflow-hidden card-hover transition duration-500 h-fit max-h-[500px]">
        <div class="p-6">
          <div class="flex flex-col items-center mb-3">
            <div class="w-20 h-20 rounded-full bg-primary-100 flex items-center justify-center text-primary-600 mb-2 avatar-ring animate-bounce-slow">
              <i class="fas fa-user-graduate text-3xl"></i>
            </div>
            <h3 class="text-xl font-bold text-secondary-800 text-center" id="username-profile"></h3>
            <p class="text-success-600 text-sm mt-1" id="user-email"></p>
            <p class="text-secondary-500 text-sm mt-1" id="user-id"></p>
         
          <div class="space-y-3">
              <div class="grid grid-cols-2 gap-2">
              </div> 
              </div>
            </div>
            <!-- Edit Profile Button -->
            <a href="setting-stu.html" class="w-full mt-4 px-4 py-2 bg-primary-600 hover:bg-primary-700 text-white rounded-lg transition duration-600 flex items-center justify-center">
              <i class="fas fa-user-edit mr-2"></i>
              Edit Profile
            </a>
        </div>
      </div>

      <!-- Recent Activity and Performance -->
      <div class="lg:col-span-2 space-y-8">
        <!-- Performance Summary -->
        <div class="bg-white rounded-xl shadow-md overflow-hidden card-hover transition duration-300">
          <div class="p-6">
            <div class="flex items-center justify-between mb-6">
              <div class="flex items-center">
                <div class="hexagon w-12 h-12 bg-primary-100 flex items-center justify-center text-primary-600 mr-4">
                  <i class="fas fa-trophy text-xl"></i>
                </div>
                <h3 class="text-lg font-semibold text-secondary-800">Performance Summary</h3>
              </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
              <div class="bg-primary-50 p-4 rounded-lg text-center hover:bg-primary-100 transition duration-300">
                <div class="text-primary-600 text-3xl font-bold mb-1" id="tests-taken">0</div>
                <div class="text-secondary-600 text-sm">Recent Tests Taken</div>
              </div>
              <div class="bg-success-50 p-4 rounded-lg text-center hover:bg-success-100 transition duration-300">
                <div class="text-success-600 text-3xl font-bold mb-1" id="average-score">0%</div>
                <div class="text-secondary-600 text-sm">Average Score</div>
              </div>
              <div class="bg-warning-50 p-4 rounded-lg text-center hover:bg-warning-100 transition duration-300">
                <div class="flex items-center justify-center">
                  <span class="text-warning-600 text-3xl font-bold mb-1 mr-1" id="streak-days">0</span>
                  <i class="fas fa-fire streak-fire" id="streak-icon"></i>
                </div>
                <div class="text-secondary-600 text-sm">Day Streak</div>
              </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <h4 class="text-sm font-medium text-secondary-500 mb-2">Best Subject</h4>
                <div class="flex items-center p-3 bg-green-50 rounded-lg">
                  <div class="mr-3 text-green-500">
                    <i class="fas fa-medal"></i>
                  </div>
                  <div>
                    <p class="text-sm font-medium text-secondary-700" id="best-subject-name">None</p>
                    <p class="text-xs text-secondary-500">Score: <span id="best-subject-score">0%</span></p>
                  </div>
                </div>
              </div>
              <div>
                <h4 class="text-sm font-medium text-secondary-500 mb-2">Needs Improvement</h4>
                <div class="flex items-center p-3 bg-blue-50 rounded-lg">
                  <div class="mr-3 text-blue-500">
                    <i class="fas fa-lightbulb"></i>
                  </div>
                  <div>
                    <p class="text-sm font-medium text-secondary-700" id="weak-subject-name">None</p>
                    <p class="text-xs text-secondary-500">Score: <span id="weak-subject-score">0%</span></p>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Recent Test Activity -->
        <div class="bg-white rounded-xl shadow-md overflow-hidden card-hover transition duration-300">
          <div class="p-6">
            <div class="flex items-center justify-between mb-6">
              <div class="flex items-center">
                <div class="hexagon w-12 h-12 bg-primary-100 flex items-center justify-center text-primary-600 mr-4">
                  <i class="fas fa-history text-xl"></i>
                </div>
                <h3 class="text-lg font-semibold text-secondary-800">Recent Test Activity</h3>
              </div>
              <a href="progressdetails.html" class="text-primary-600 hover:text-primary-800 text-sm font-medium">View All</a>
            </div>

            <div class="overflow-x-auto">
              <table class="min-w-full divide-y divide-secondary-200">
                <thead class="bg-secondary-50">
                  <tr>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-secondary-500 uppercase tracking-wider">Date</th>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-secondary-500 uppercase tracking-wider">Subject</th>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-secondary-500 uppercase tracking-wider">Score</th>
                  </tr>
                </thead>
                <tbody class="bg-white divide-y divide-secondary-200" id="examResults">
                  <tr>
                    <td colspan="5" class="px-6 py-4 text-center text-sm text-secondary-500">
                      Loading test history...
                    </td>
                  </tr>
                </tbody>
              </table>

              
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <footer>
        <div class="footer-content">
                </div>
                <span>Jahizyah</span>
            <div class="footer-links">
                <a href="Main-stu.html">Home</a>
                <a href="about-s.html">About Us</a>
                <a href="contact-s.html">Contact</a>
            </div>
            
            <p class="copyright">© 2025 Jahizyah Educational Platform. All Rights Reserved.<br>
            Assess Your Level And Get Personalized Recommendations | Choose The Subject You Want To Test Your Knowledge In</p>
        </div>
    </footer>

  <!-- Firebase Libraries -->
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>

 
<script>
 

  // Firebase configuration
  const firebaseConfig = {
    apiKey: "AIzaSyAI30r2_rI6vsuoaZIvzZQkauZ0d7KlhwI",
    authDomain: "infohive-fda92.firebaseapp.com",
    projectId: "infohive-fda92",
    storageBucket: "infohive-fda92.appspot.com",
    messagingSenderId: "938794496627",
    appId: "1:938794496627:web:467f85ce9e035a2136b006"
  };

  // Initialize Firebase
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();
  

  // Authentication state observer
  auth.onAuthStateChanged(async (user) => {
    if (!user) {
      // Redirect to login if not authenticated
      window.location.href = "../../login.html";
      return;
    }

    const uid = user.uid;

    // ========== بيانات الطالب ==========
    try {
      const userDoc = await db.collection("users").doc(uid).get();
      if (userDoc.exists) {
        const userData = userDoc.data();

        // Update profile information
        document.getElementById("username-header").textContent = userData.name || "Student";
        document.getElementById("username-profile").textContent = userData.name || "Student";
        document.getElementById("user-email").textContent = userData.email || user.email || "No email";

        // Initialize streak if not exists
        if (!userData.streak) {
          const today = new Date().toISOString().split('T')[0];
          await db.collection("users").doc(uid).update({
            streak: 1,
            lastActiveDate: today
          });
        }

        // Update student information if available
        
      }
    } catch (error) {
      console.error("Error fetching user data:", error);
    }

    // ========== التقدم في المواد ==========
    try {
      const subjectsSnap = await db.collection("subjects").where("studentId", "==", uid).get();
      let totalSum = 0;
      let totalCount = 0;
      let bestSubject = { name: "", score: 0 };
      let weakSubject = { name: "", score: 100 };

      subjectsSnap.forEach((doc) => {
        const sub = doc.data();
        const progress = sub.progress || 0;

      

        // Track best and weak subjects
        if (progress > bestSubject.score) {
          bestSubject = { name: sub.subjectName, score: progress };
        }
        if (progress < weakSubject.score) {
          weakSubject = { name: sub.subjectName, score: progress };
        }

        totalSum += progress;
        totalCount++;
      });

      // Calculate and display total progress
      const totalProgress = totalCount ? Math.round(totalSum / totalCount) : 0;
      document.getElementById("total-bar").style.width = totalProgress + "%";
      document.getElementById("total-percent").textContent = totalProgress + "%";
    } catch (error) {
      console.error("Error fetching subject data:", error);
    }

  // جلب نتائج الاختبارات للطالب حسب studentId
 try {
  const resultsSnap = await db.collection("examResults")
    .where("studentId", "==", uid) 
    .orderBy("timestamp", "desc") 
    .limit(5) 
    .get();

  let html = "";
  let totalScore = 0;
  let testCount = 0;
  let subjectScores = {};

  if (resultsSnap.empty) {
    html = `
      <tr>
        <td colspan="5" class="px-6 py-4 text-center text-sm text-secondary-500">
          No test history available. Take your first test!
        </td>
      </tr>
    `;
  } else {
    resultsSnap.forEach(doc => {
      const r = doc.data();
      // استخراج القيم من الحقول المختلفة
      const date = r.timestamp 
        ? new Date(r.timestamp.seconds * 1000).toLocaleDateString()
        : r.date || "N/A";
      // استخراج اسم المادة
      const subject = r.subject || (r.testResults && r.testResults.subject) || "N/A";
      // استخراج الدرجة
      const score = typeof r.Score === "number" ? r.Score : 
        (r.testResults && typeof r.testResults.Score === "number" ? r.testResults.Score : r.score || 0);
      const timeSpent = r.timeSpent || (r.testResults && r.testResults.timeSpent) || "N/A";

      const scoreColor = score >= 70 ? "text-success-500" : score >= 50 ? "text-warning-500" : "text-red-500";

      // جمع درجات المواد
      if (!subjectScores[subject]) subjectScores[subject] = [];
      subjectScores[subject].push(score);

      html += `
        <tr class="hover:bg-secondary-50 transition">
          <td class="px-6 py-4 whitespace-nowrap text-sm text-secondary-500">${date}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-secondary-900">${subject}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm ${scoreColor} font-bold">${score}%</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-secondary-500">
          </td>
        </tr>
      `;
      totalScore += score;
      testCount++;
    });

    // حساب أفضل وأضعف مادة
    let bestSubject = { name: "None", score: -1 };
    let weakSubject = { name: "None", score: 101 };
    Object.keys(subjectScores).forEach(sub => {
      const scores = subjectScores[sub];
      const avg = scores.reduce((a,b)=>a+b, 0) / scores.length;
      if (avg > bestSubject.score) {
        bestSubject = { name: sub, score: Math.round(avg) };
      }
      if (avg < weakSubject.score) {
        weakSubject = { name: sub, score: Math.round(avg) };
      }
    });

    // تحديث عناصر الصفحة
    document.getElementById("best-subject-name").textContent = bestSubject.name;
    document.getElementById("best-subject-score").textContent = bestSubject.score > -1 ? bestSubject.score + "%" : "0%";
    document.getElementById("weak-subject-name").textContent = weakSubject.name;
    document.getElementById("weak-subject-score").textContent = weakSubject.score < 101 ? weakSubject.score + "%" : "0%";
  }

  // تحديث الجدول بالنتائج
  document.getElementById("examResults").innerHTML = html;
  // تحديث عدد الاختبارات والمعدل
  document.getElementById("tests-taken").textContent = testCount;
  document.getElementById("average-score").textContent = testCount > 0 ? Math.round(totalScore/testCount) + "%" : "0%";
 } catch(error) {
  console.error("Error fetching examResults:", error);
 }

 
    // ========== streak days ==========
    try {
      const userRef = db.collection("users").doc(uid);
      const userDoc = await userRef.get();
      const userData = userDoc.data();

      // Get current date in YYYY-MM-DD format
      const today = new Date().toISOString().split('T')[0];

      if (userData && userData.lastActiveDate) {
        const lastActive = userData.lastActiveDate;
        const yesterday = new Date();
        yesterday.setDate(yesterday.getDate() - 1);
        const yesterdayStr = yesterday.toISOString().split('T')[0];

        let streak = userData.streak || 0;

        // If user was active yesterday or today, continue streak
        if (lastActive === yesterdayStr || lastActive === today) {
          // If first activity today, increment streak
          if (lastActive === yesterdayStr) {
            streak++;
          }
        } else {
          // Reset streak if broken
          streak = 1;
        }

        // Update streak and last active date
        await userRef.update({
          streak: streak,
          lastActiveDate: today
        });

        document.getElementById("streak-days").textContent = streak;
        const streakIcon = document.getElementById("streak-icon");
        if (streakIcon) {
          if (streak > 0) {
            streakIcon.classList.remove("hidden");
          } else {
            streakIcon.classList.add("hidden");
          }
        }
      } else {
        // First time user - initialize streak
        await userRef.update({
          streak: 1,
          lastActiveDate: today
        });
        document.getElementById("streak-days").textContent = 1;
      }
    } catch (error) {
      console.error("Error updating streak:", error);
    }

    // Animate progress bars after data is loaded
    setTimeout(() => {
      const progressBars = document.querySelectorAll('.progress-bar');
      progressBars.forEach(bar => {
        const width = bar.style.width;
        bar.style.width = '0%';
        setTimeout(() => {
          bar.style.width = width;
        }, 100);
      });
    }, 500);
  });


  // Add hover effects to all cards
  document.querySelectorAll('.card-hover').forEach(card => {
    card.addEventListener('mouseenter', () => {
      card.classList.add('shadow-lg');
    });
    card.addEventListener('mouseleave', () => {
      card.classList.remove('shadow-lg');
    });
  });

  

  // Logout button
  if (document.getElementById('logoutBtn')) {
    document.getElementById('logoutBtn').addEventListener('click', logout);
  }
  // Logout function
  function logout() {
    auth.signOut()
      .then(() => {
        window.location.href = "../../home.html";
      })
      .catch(error => {
        alert("Logout error: " + error.message);
      });
  }
 



</script>
</body>
</html>
